<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ввод кода</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <h1>Ввод кода из Telegram</h1>
    <p>Введите код, отправленный в ваш Telegram.</p>
    <div class="form">
      <input id="phone" type="tel" placeholder="+7XXXXXXXXXX">
      <input id="code" type="text" placeholder="Код из Telegram">
      <button id="signIn" type="button">Войти</button>
    </div>
    <div class="form" id="twofa" style="display:none">
      <input id="password" type="password" placeholder="Пароль 2FA">
      <button id="signIn2fa" type="button">Войти по паролю</button>
    </div>
    <div id="status" class="status"></div>
  </div>
  <script>
    const API_BASE=(typeof window!=='undefined'&&window.API_BASE)?window.API_BASE:'/';
    const s=document.getElementById('status');
    const phone=document.getElementById('phone');
    const code=document.getElementById('code');
    const pass=document.getElementById('password');
    const twofa=document.getElementById('twofa');
    async function post(p,b){
      const r=await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
      return r.json();
    }
    document.getElementById('signIn').onclick=async()=>{
      s.textContent='Проверка кода…';
      const res=await post('/api/sign_in',{phone:phone.value.trim(),code:code.value.trim()});
      if(res.ok){
        s.textContent='Успешный вход: @'+(res.user.username||res.user.id);
      }else if(res.2fa_required){
        twofa.style.display='flex';
        s.textContent='Требуется пароль 2FA';
      }else{
        s.textContent='Ошибка: '+(res.error||'');
      }
    };
    document.getElementById('signIn2fa').onclick=async()=>{
      s.textContent='Вход по 2FA…';
      const res=await post('/api/sign_in_2fa',{phone:phone.value.trim(),password:pass.value});
      s.textContent=res.ok?'Успешный вход: @'+(res.user.username||res.user.id):'Ошибка: '+(res.error||'');
    };
  </script>
</body>
</html>
